import { css, LitElement } from 'lit';
import styleCssAuroHyperlink from '@aurodesignsystem/auro-hyperlink/src/style-css.js';
import colorCssAuroHyperlink from '@aurodesignsystem/auro-hyperlink/src/color-css.js';
import AuroLibraryRuntimeUtils from '@aurodesignsystem/auro-library/scripts/utils/runtimeUtils.mjs';
import { AuroHyperlink } from '@aurodesignsystem/auro-hyperlink/src/auro-hyperlink.js';
import { html } from 'lit/static-html.js';
import { classMap } from 'lit/directives/class-map.js';
import { AuroDependencyVersioning } from '@aurodesignsystem/auro-library/scripts/runtime/dependencyTagVersioning.mjs';
import { AuroButton } from '@aurodesignsystem/auro-button/src/auro-button.js';
import { AuroIcon } from '@aurodesignsystem/auro-icon/src/auro-icon.js';

var styleBreadcrumbCss = css`*,*:before,*:after{box-sizing:border-box}@media(prefers-reduced-motion: reduce){*,*:before,*:after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}}*:focus-visible{outline:0}*:focus-visible{outline:0}:focus:not(:focus-visible){outline:3px solid transparent}:host{display:inline-flex}:host .hyperlink:focus,:host .hyperlink:hover{text-decoration:underline}:host ::slotted([name=chevron-left]){display:none}:host:after{position:relative;display:inline-block;width:var(--ds-size-300, 1.5rem);height:var(--ds-size-300, 1.5rem);top:-1px;line-height:var(--ds-size-300, 1.5rem);margin-right:5px;margin-left:var(--ds-size-100, 0.5rem);content:"";-webkit-mask-box-image:url("https://cdn.jsdelivr.net/npm/@alaskaairux/icons@latest/dist/icons/interface/chevron-right.svg");mask-image:url("https://cdn.jsdelivr.net/npm/@alaskaairux/icons@latest/dist/icons/interface/chevron-right.svg");mask-repeat:no-repeat}:host a{text-decoration:none}@media screen and (max-width: 576px){:host ::slotted([name=chevron-left]){display:inline-block}:host ::slotted([name=home-stroke]){display:none}:host:after{content:unset}}:host(:not(:first-of-type)) ::slotted([name=home-stroke]){display:none}:host(:last-of-type):after{content:unset}@media screen and (max-width: 576px){:host(:not(:nth-last-of-type(2))){display:none}}`;

var colorBreadcrumbCss = css`*,*:before,*:after{box-sizing:border-box}@media(prefers-reduced-motion: reduce){*,*:before,*:after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}}*:focus-visible{outline:0}*:focus-visible{outline:0}:focus:not(:focus-visible){outline:3px solid transparent}:host:after{background-color:var(--ds-auro-breadcrumb-chevron-color)}:host ::slotted([auro-icon][name=home-stroke]),:host ::slotted([auro-icon][name=chevron-left]){color:var(--ds-auro-breadcrumb-icon-color)}:host a{--ds-auro-hyperlink-visited-color-default: var(--ds-color-text-ui-default-default, #2c67b5);--ds-auro-hyperlink-focus-color-default: var(--ds-color-text-ui-default-default, #2c67b5);--ds-auro-hyperlink-hover-color-default: var(--ds-color-text-ui-hover-default, #193d73)}:host(:hover){--ds-auro-breadcrumb-icon-color: var(--ds-color-icon-ui-primary-hover-default, #193d73)}:host(:last-of-type){color:var(--ds-auro-breadcrumb-last-link-text-color)}`;

var tokensCss = css`:host{--ds-auro-anchornav-label-color: var(--ds-color-text-secondary-default, #525252);--ds-auro-anchornav-mobile-background-gradient: linear-gradient(180deg, rgba(255, 255, 255, 0.0001) 0%, rgba(255, 255, 255, 0.00874633) 6.67%, rgba(255, 255, 255, 0.0356065) 13.33%, rgba(255, 255, 255, 0.0817517) 20%, rgba(255, 255, 255, 0.147497) 26.67%, rgba(255, 255, 255, 0.231852) 33.33%, rgba(255, 255, 255, 0.331951) 40%, rgba(255, 255, 255, 0.442747) 46.67%, rgba(255, 255, 255, 0.557353) 53.33%, rgba(255, 255, 255, 0.668149) 60%, rgba(255, 255, 255, 0.768248) 66.67%, rgba(255, 255, 255, 0.852603) 73.33%, rgba(255, 255, 255, 0.918348) 80%, rgba(255, 255, 255, 0.964494) 86.67%, rgba(255, 255, 255, 0.991354) 93.33%, #FFFFFF 100%);--ds-auro-anchornav-selected-marker-color: var(--ds-color-border-primary-default, #585e67);--ds-auro-anchorlink-border-color: transparent;--ds-auro-anchorlink-default-marker-color: var(--ds-color-border-divider-default, rgba(0, 0, 0, 0.12));--ds-auro-anchorlink-text-color: var(--ds-color-text-tertiary-default, #6a717c);--ds-auro-breadcrumb-chevron-color: var(--ds-color-icon-secondary-default, #7e8894);--ds-auro-breadcrumb-icon-color: var(--ds-color-icon-ui-primary-default-default, #2c67b5);--ds-auro-breadcrumb-last-link-text-color: var(--ds-color-text-tertiary-default, #6a717c)}`;

// Copyright (c) 2022 Alaska Airlines. All right reserved. Licensed under the Apache-2.0 license
// See LICENSE in the project root for license information.


// build the component class
class AuroBreadcrumb extends AuroHyperlink {
  static get styles() {
    return [
      styleCssAuroHyperlink,
      colorCssAuroHyperlink,
      styleBreadcrumbCss,
      colorBreadcrumbCss,
      tokensCss
    ];
  }

  /**
   * This will register this element with the browser.
   * @param {string} [name="auro-breadcrumb"] - The name of element that you want to register to.
   *
   * @example
   * AuroBreadcrumb.register("custom-breadcrumb") // this will register this element to <custom-breadcrumb/>
   *
   */
  static register(name = "auro-breadcrumb") {
    AuroLibraryRuntimeUtils.prototype.registerComponent(name, AuroBreadcrumb);
  }

  firstUpdated() {
    AuroLibraryRuntimeUtils.prototype.handleComponentTagRename(this, 'auro-breadcrumb');

    this.addEventListener('click', (evt) => {
      // Prevents from href from being followed (this is used for testing)
      evt.preventDefault();
      this.active = true;
    });
  }
}

var styleAnchorlinkCss = css`*,*:before,*:after{box-sizing:border-box}@media(prefers-reduced-motion: reduce){*,*:before,*:after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}}*:focus-visible{outline:0}*:focus-visible{outline:0}:focus:not(:focus-visible){outline:3px solid transparent}:host{display:block;border-width:1px;border-style:solid}:host a{display:block;text-decoration:none;font-size:var(--ds-text-body-size-sm, 0.875rem);width:100%;padding:var(--ds-size-100, 0.5rem) var(--ds-size-200, 1rem) var(--ds-size-100, 0.5rem) var(--ds-size-200, 1rem)}:host a:focus{outline:unset}:host .hyperlink{white-space:unset}:host(:focus){border-width:1px;border-style:solid;border-radius:5px}`;

var colorAnchorlinkCss = css`*,*:before,*:after{box-sizing:border-box}@media(prefers-reduced-motion: reduce){*,*:before,*:after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}}*:focus-visible{outline:0}*:focus-visible{outline:0}:focus:not(:focus-visible){outline:3px solid transparent}:host{border-color:var(--ds-auro-anchorlink-border-color);border-left-color:var(--ds-auro-anchorlink-default-marker-color)}:host a{color:var(--ds-auro-anchorlink-text-color)}:host([active]),:host(:hover){--ds-auro-anchorlink-text-color: var(--ds-color-text-primary-default, #2a2a2a)}:host(:focus){--ds-auro-anchorlink-border-color: var(--ds-color-border-ui-focus-default, #2c67b5);--ds-auro-anchorlink-default-marker-color: var(--ds-color-border-ui-focus-default, #2c67b5)}:host(:focus:hover){--ds-auro-anchorlink-text-color: var(--ds-color-text-primary-default, #2a2a2a)}`;

// Copyright (c) 2022 Alaska Airlines. All right reserved. Licensed under the Apache-2.0 license
// See LICENSE in the project root for license information.


// See https://git.io/JJ6SJ for "How to document your components using JSDoc"
/**
 * The auro-nav element provides users a way to ... (it would be great if you fill this out).
 *
 * @attr {Boolean} active - If set, dethe link is currently the active link in the parent auro-nav.
 */

// build the component class
class AuroAnchorlink extends AuroHyperlink {
  static get properties() {
    return {
      // ...super.properties,
      active: {
        type: Boolean,
        reflect: true
      }
    };
  }

  static get styles() {
    return [
      styleCssAuroHyperlink,
      colorCssAuroHyperlink,
      styleAnchorlinkCss,
      colorAnchorlinkCss,
      tokensCss
    ];
  }

  /**
   * This will register this element with the browser.
   * @param {string} [name="auro-anchorlink"] - The name of element that you want to register to.
   *
   * @example
   * AuroAnchorlink.register("custom-anchorlink") // this will register this element to <custom-anchorlink/>
   *
   */
  static register(name = "auro-anchorlink") {
    AuroLibraryRuntimeUtils.prototype.registerComponent(name, AuroAnchorlink);
  }

  updated(changedProperties) {
    if (changedProperties.has('active')) {
      if (this.active) {
        this.dispatchEvent(new CustomEvent('auroAnchorLink-activated', {
          bubbles: true,
          composed: true
        }));
      }
    }
  }

  firstUpdated() {
    AuroLibraryRuntimeUtils.prototype.handleComponentTagRename(this, 'auro-anchorlink');

    this.addEventListener('click', (evt) => {
      // Prevents from href from being followed (this is used for testing)
      evt.preventDefault();
      this.active = true;
    });
  }
}

var buttonVersion = '8.1.0';

var iconVersion = '5.0.2';

var styleCss = css`*,*:before,*:after{box-sizing:border-box}@media(prefers-reduced-motion: reduce){*,*:before,*:after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}}*:focus-visible{outline:0}*:focus-visible{outline:0}:focus:not(:focus-visible){outline:3px solid transparent}:host([anchornav]){position:relative}:host([anchornav]) .label-container{padding-bottom:var(--ds-size-200, 1rem)}:host([anchornav]) .label-container.hidden{display:none}@media screen and (max-width: 576px){:host([anchornav]) .showHideBtn{display:block}}@media screen and (max-width: 576px){:host([anchornav]:not([aria-expanded])):before{position:absolute;bottom:0;left:0;display:block;width:100%;height:100%;content:"";pointer-events:none}:host([anchornav]:not([aria-expanded])) .showHideBtn [more]{display:none}:host([anchornav]:not([aria-expanded])) .showHideBtn [less]{display:inline}:host([anchornav]:not([aria-expanded])) ::slotted(auro-anchorlink){display:none}:host([anchornav]:not([aria-expanded])) ::slotted(auro-anchorlink:nth-of-type(1)),:host([anchornav]:not([aria-expanded])) ::slotted(auro-anchorlink:nth-of-type(2)),:host([anchornav]:not([aria-expanded])) ::slotted(auro-anchorlink:nth-of-type(3)){display:block}}.showHideBtn{display:none;margin-top:var(--ds-size-150, 0.75rem)}.showHideBtn [less]{display:none}.anchorMarker{position:absolute;left:0;display:none;width:2px}.anchorMarker:not([resizing]){transition:400ms ease-out}`;

var colorCss = css`*,*:before,*:after{box-sizing:border-box}@media(prefers-reduced-motion: reduce){*,*:before,*:after{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}}*:focus-visible{outline:0}*:focus-visible{outline:0}:focus:not(:focus-visible){outline:3px solid transparent}:host([anchornav]) .label-container{color:var(--ds-auro-anchornav-label-color)}@media screen and (max-width: 576px){:host([anchornav]:not([aria-expanded])):before{background:var(--ds-auro-anchornav-mobile-background-gradient)}}.anchorMarker{background:var(--ds-auro-anchornav-selected-marker-color)}`;

// Copyright (c) 2022 Alaska Airlines. All right reserved. Licensed under the Apache-2.0 license
// See LICENSE in the project root for license information.


// See https://git.io/JJ6SJ for "How to document your components using JSDoc"
/**
 * The auro-nav element provides a way to show users a secondary navigation aid that helps them understand the relation between the location of their current page and higher level pages.
 *
 * @attr {Boolean} activeLink - If set, defines the currently active link.
 * @attr {String} anchorNavContent - Defines the container that anchor links navigate within.
 * @slot Slot for insertion of navigation links.
 * @slot mobileToggleExpanded - Slot for button text in mobile when content is expanded.
 * @slot mobileToggleCollapsed - Slot for button text in mobile when content is collapsed.
 */

// build the component class
class AuroNav extends LitElement {
  constructor() {
    super();

    this.anchorNavContent = undefined;

    const versioning = new AuroDependencyVersioning();

    /**
     * @private
     */
    this.buttonTag = versioning.generateTag('auro-button', buttonVersion, AuroButton);

    /**
     * @private
     */
    this.iconTag = versioning.generateTag('auro-icon', iconVersion, AuroIcon);

    /**
     * @private
     */
    this.runtimeUtils = new AuroLibraryRuntimeUtils();

    /**
     * @private
     */
    this.activeLink = undefined;

    /**
     * @private
     */
    this.labelHidden = true;

    /**
     * @private
     */
    this.mobileViewCollapsedNumLinks = 3;
  }

  // This function is to define props used within the scope of this component
  // Be sure to review  https://lit-element.polymer-project.org/guide/properties#reflected-attributes
  // to understand how to use reflected attributes with your property settings.
  static get properties() {
    return {
      // ...super.properties,
      activeLink: { type: Object },
      anchorNavContent: { type: String }
    };
  }

  static get styles() {
    return [
      styleCss,
      colorCss,
      tokensCss
    ];
  }

  /**
   * This will register this element with the browser.
   * @param {string} [name="auro-nav"] - The name of element that you want to register to.
   *
   * @example
   * AuroNav.register("custom-nav") // this will register this element to <custom-nav/>
   *
   */
  static register(name = "auro-nav") {
    AuroLibraryRuntimeUtils.prototype.registerComponent(name, AuroNav);
  }

  /**
   * @private
   * @returns {void} Sets the labelHidden attribute to true if there is no label slot content.
   */
  handleLabelSlot() {
    const slot = this.shadowRoot.querySelector('#label');

    this.labelHidden = true;

    if (slot.assignedNodes().length > 0) {
      this.labelHidden = false;
    }
  }

  /**
   * @private
   * @returns {void} Inserts home and chevron-left icons for every breadcrumb.
   */
  handleSlotItems() {
    this.manageBreadcrumbs();
    this.manageAnchorlinks();
  }

  /**
   * @private
   * @returns {void} Inserts home and chevron-left icons for every breadcrumb.
   */
  manageBreadcrumbs() {
    const breadcrumbs = [...this.querySelectorAll('auro-breadcrumb, [auro-breadcrumb]')];

    if (breadcrumbs.length > 0) {
      breadcrumbs.forEach((breadcrumb) => {
        this.insertIcon(breadcrumb, 'interface', 'home-stroke', 'var(--ds-size-200)');
        this.insertIcon(breadcrumb, 'interface', 'chevron-left', 'var(--ds-size-300)');
      });
    }
  }

  /**
   * Used for the anchorLink version to bind events to all link elements in the slotted content.
   * @private
   * @returns {void}
   */
  manageAnchorlinks() {
    this.anchorlinks = [...this.querySelectorAll('auro-anchorlink, [auro-anchorlink]')];

    if (this.anchorlinks.length > 0) {
      this.setAttribute('anchornav', true);
      this.requestUpdate();

      this.anchorlinks.forEach((link) => {
        if (link.active) {
          this.activeLink = link;
        }

        link.addEventListener('auroAnchorLink-activated', (evt) => {
          if (this.activeLink !== evt.target) {
            this.activeLink = evt.target;
          }
        });

        link.addEventListener('click', (evt) => {
          if (this.scrollContainer && this.activeLink) {
            const targetContent = document.querySelector(evt.target.href);

            if (targetContent) {
              targetContent.scrollIntoView(targetContent);
            }
          }
        });
      });

      this.assessActiveAnchorLink();
    }
  }

  /**
   * Used to toggle visibility of all links after the first 3 when viewed in the mobile layout.
   * @private
   * @returns {void}
   */
  toggleAnchorLinks() {
    if (!this.hasAttribute('aria-expanded')) {
      this.setAttribute('aria-expanded', true);
    } else {
      this.removeAttribute('aria-expanded');
    }

    this.handleAnchorNavAnimation();
  }

  /**
   * Used for the anchorLink version to animate the position and size of the marker used to identify the active link.
   * @private
   * @returns {void}
   */
  handleAnchorNavAnimation() {
    const marker = this.shadowRoot.querySelector('#anchorMarker');

    if (marker) {
      if (this.activeLink) {
        marker.style.display = 'block';
        marker.style.height = `${this.activeLink.offsetHeight}px`;
        marker.style.top = `${this.activeLink.offsetTop}px`;
      } else {
        marker.style.display = 'none';
        marker.style.height = 'unset';
        marker.style.top = 'unset';
      }
    }
  }

  /**
   * @private
   * @param {Object} link - Hyperlink in which the auro-icon is inserted.
   * @param {String} category - Category that the auro-icon is classified under.
   * @param {String} name - Name of the auro-icon.
   * @param {String} size - Height and width of the auro-icon.
   * @returns {void} Configures icon to be placed within each hyperlink.
   */
  insertIcon(link, category, name, size) {
    const icon = document.createElement(this.iconTag._$litStatic$);

    icon.setAttribute('customSize', true);
    icon.setAttribute('customColor', true);

    icon.category = category;
    icon.name = name;

    icon.style.width = size;
    icon.style.height = size;
    icon.style.lineHeight = `1.5rem`;
    icon.style.position = 'relative';
    icon.style.top = '-2px';
    icon.style.marginRight = `0.25rem`;

    link.insertAdjacentElement('afterbegin', icon);
  }

  /**
   * Sets the activeLink attribute based on which linked content section is in view.
   * @private
   * @returns {void}
   */
  assessActiveAnchorLink() {
    let lastInView; /* eslint-disable-line init-declarations */

    this.anchorlinks.forEach((anchorLink) => {
      const target = this.scrollContainer.querySelector(anchorLink.getAttribute('href'));

      if (target) {
        if (this.isScrolledIntoView(target)) {
          lastInView = anchorLink;
        }
      }
    });

    if (this.activeLink !== lastInView) {
      this.activeLink = lastInView;
    }
  }

  /**
   * Used with the anchorLink version to determine if the designated content is currently viewable in the scrollbox.
   * @private
   * @param {Object} elem - The element to check if it is currently visible in the scrollContainer.
   * @returns {Boolean} If true, the element passed in is visible.
   */
  isScrolledIntoView(elem) {
    const containerViewBottom = this.scrollContainer.scrollTop + this.scrollContainer.offsetHeight;
    const elementInViewPos = elem.offsetTop + elem.offsetHeight;
    const inView = containerViewBottom >= elementInViewPos;

    return inView;
  }

  updated(changedProperties) {
    if (changedProperties.has('activeLink')) {
      if (this.hasAttribute('anchornav')) {
        this.anchorlinks.forEach((anchorlink) => {
          if (this.activeLink !== anchorlink) {
            anchorlink.removeAttribute('active');
          }
        });

        this.handleAnchorNavAnimation();
      }
    }
  }

  firstUpdated() {
    // Add the tag name as an attribute if it is different than the component name
    this.runtimeUtils.handleComponentTagRename(this, 'auro-nav');

    this.scrollContainer = document.querySelector(this.anchorNavContent);

    if (this.scrollContainer) {
      this.scrollContainer.addEventListener('scroll', () => {
        this.assessActiveAnchorLink();
      });
    }

    window.addEventListener('resize', () => {
      const marker = this.shadowRoot.querySelector('#anchorMarker');
      if (marker) {
        marker.setAttribute('resizing', true);
        this.handleAnchorNavAnimation();
        marker.removeAttribute('resizing');
      }
    });
  }

  // function that renders the HTML and CSS into  the scope of the component
  render() {
    const labelClasses = {
      'hidden': this.labelHidden,
      'label-container': true
    };

    return html`
      <div aria-label="navigation" role="navigation">
        <div class=${classMap(labelClasses)}>
          <slot id="label" name="label" @slotchange="${this.handleLabelSlot}"></slot>
        </div>
        <slot @slotchange="${this.handleSlotItems}"></slot>
      </div>
      ${this.anchorlinks && this.anchorlinks.length > this.mobileViewCollapsedNumLinks ? html`
        <${this.buttonTag} slim tertiary class="showHideBtn" @click=${this.toggleAnchorLinks}>
          <span more>
            <slot name="mobileToggleExpanded"></slot>
          </span>
          <span less>
            <slot name="mobileToggleCollapsed"></slot>
          </span>
        </${this.buttonTag}>
      ` : undefined}
      ${this.anchorlinks ? html`
        <div id="anchorMarker" class="anchorMarker"></div>
      ` : undefined}
    `;
  }
}

AuroBreadcrumb.register();
AuroAnchorlink.register();
AuroNav.register();
